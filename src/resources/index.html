<!DOCTYPE html>
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="scripts/jQuery.js"></script>
        <script src="scripts/mustache.min.js"></script>
        <script src="scripts/js/bootstrap.js"></script>
        <link rel="stylesheet" href="scripts/css/bootstrap.css">
        <style>
            a:hover { 
                background-color: black; 
            }
            .btn-circle {
                width: 30px;
                height: 30px;
                text-align: center;
                padding: 6px 0;
                font-size: 12px;
                line-height: 1.428571429;
                border-radius: 15px;
                border-style: solid;
                border-color: gray;
                border-width: 1px;
            }
        </style>
        <script>
            $(document).ready(function(){
                //Load the category view first
                var accountsJSON = JSON.parse(accountController.getCategoryViewModel());
                $("#display").load("categories.html", function(){
                    var template = $("template").html();
                    accountsJSON.forEach(function(data){
                        var button = Mustache.render(template, data);
                        var buttonContainer = "<div class='col-sm-4'>" + button + "</div>"
                        $("#buttonDisplay").append(buttonContainer);
                    });
                    
                    deleteAndEditIcons();
                    
                    //Delete event
                    $(".deleteCategoryButton").click(function(){
                        accountController.deleteCategory($(this).data("category"));
                        $(this).parent().parent().parent().remove();
                    });
                    
                    //Edit modal for the category view
                    $('#editModal').on('show.bs.modal', function(event){                    
                        var button = $(event.relatedTarget) // Button that triggered the modal
                        var category = button.data('category') // Extract info from data-* attributes
                        var modal = $("#editModal");
                        modal.find('.modal-title').text('Edit ' + category + ' category')
                        modal.find('.modal-body input').val(category)

                        //Do a submit event
                        $("#editCategorySubmitButton").click(function(){
                            var success = accountController.editCategory(button.data('category'), modal.find('.modal-body input').val())
                            if(success){
                                //Rerender the category button with its new category name
                                button.data('category',modal.find('.modal-body input').val())
                                button.parent().parent().find('.card-header').data('category',modal.find('.modal-body input').val());
                                button.parent().parent().find('h1').html(modal.find('.modal-body input').val()); 
                            }
                            $("#editCategorySubmitButton").off( 'click' );
                        });
                    });
                });
                
                //Load account type view when category is clicked
                $('#display').on('click', '.category-button', function() {
                    var accountsJSON = JSON.parse(accountController.getAccountTypeViewModel($(this).data("category")));
                    $("#display").load("accountTypes.html", function(){
                        var template = $("template").html();
                        $.each(accountsJSON, function(key, value){
                            var button = Mustache.render(template, value);
                            var buttonContainer = "<div class='col-sm-4'>" + button + "</div>"
                            $("#buttonDisplay").append(buttonContainer);
                        });
                        
                        deleteAndEditIcons();
                        
                        //Edit modal for the category view
                        $('#editModal').on('show.bs.modal', function(event){
                            var button = $(event.relatedTarget) // Button that triggered the modal
                            var accountType = button.data('accounttype') // Extract info from data-* attributes
                            var modal = $(this)
                            modal.find('.modal-title').text('Edit ' + accountType + ' account type')
                            modal.find('.modal-body input').val(accountType)

                            //Do a submit event
                            $("#editAccountTypeSubmitButton").click(function(){
                                var success = accountController.editAccountType(button.data('category'), button.data('accounttype'), modal.find('.modal-body input').val())
                                if(success){
                                    //Rerender the category button with its new category name
                                    button.data('accounttype',modal.find('.modal-body input').val())
                                    button.parent().parent().find('.card-header').data('accounttype',modal.find('.modal-body input').val());
                                    button.parent().parent().find('h1').html(modal.find('.modal-body input').val()); 
                                }
                                $("#editAccountTypeSubmitButton").off( 'click' );
                            });
                        });
                    });
                });
                
                //Load accounts when account types is clicked
                $('#display').on('click', '.account-type-button', function() {
                    var accountsJSON = JSON.parse(accountController.getAccountViewModel($(this).data("category"),$(this).data("accounttype")));     
                    $("#display").load("accounts.html", function(){
                        var template = $("template").html();
                        $.each(accountsJSON, function(key, value){
                            var templateComplete = Mustache.render(template, value);
                            $("#buttonDisplay").append(templateComplete);
                        });
                    });
                });
                
                //Display the account details view when an account is clicked
                $('#display').on('click', '.user-name-button', function() {
                    var accountsJSON = JSON.parse(accountController.getAccountDetailsViewModel($(this).data("category"), $(this).data("accounttype"), $(this).data("username")));     
                    $("#display").load("accountDetails.html", function(){
                        var template = $("template").html();
                        $.each(accountsJSON, function(index, element){
                            $.each(element.account.accountDetails, function(key, value){
                                var templateComplete = Mustache.render(template, {value:value, key:key, category: element.category, accountType: element.accountType, userName: element.account.accountDetails.userName});
                                $("#buttonDisplay").append(templateComplete);
                            });
                        });
                        deleteAndEditIcons();
                        
                        //Edit modal for the category view
                        $('#editModal').on('show.bs.modal', function(event){
                            var button = $(event.relatedTarget) // Button that triggered the modal
                            var field = button.data('field') // Extract info from data-* attributes
                            var fieldValue = button.data('fieldvalue')
                            var modal = $(this)
                            modal.find('.modal-title').text('Edit account ' + field)
                            modal.find('.modal-body input').val(fieldValue)

                            //Do a submit event
                            $("#editCategorySubmitButton").click(function(){
                                var success = accountController.editAccount(button.data('category'), button.data('accounttype'), button.data('username'), button.data('field'), button.data('fieldvalue'), modal.find('.modal-body input').val())
                                if(success){
                                    button.data('fieldvalue',modal.find('.modal-body input').val())
                                    button.parent().parent().find('.fieldValueDisplay').html(modal.find('.modal-body input').val());
                                }
                                $("#editCategorySubmitButton").off( 'click' );
                            });
                        });
                    });
                });
                
                
                
                
                
                
                // Delete and Edit button
                function deleteAndEditIcons(){
                    $(".delete-icon").html("<img class='img-fluid' src='scripts/delete.png'>");
                    $(".edit-icon").html("<img class='img-fluid' src='scripts/edit.png'>");
                
                    $(".delete-icon").hover(function(){
                        $(this).html("<img class='img-fluid' src='scripts/deletewhite.png'>");
                    },function(){
                        $(this).html("<img class='img-fluid' src='scripts/delete.png'>");
                    });
                    
                    $(".edit-icon").hover(function(){
                        $(this).html("<img class='img-fluid' src='scripts/editwhite.png'>");
                    },function(){
                        $(this).html("<img class='img-fluid' src='scripts/edit.png'>");
                    });
                }
             });
        </script>
    </head>
    <body>   
        <!--
            <div class="row">
                <div class="card">
                                 <div class="card-header d-flex flex-row justify-content-center" style="width:20rem;height:15rem">
                        <h1 class="align-self-center">Download</h1>
                    </div>
                    <div class="card-body d-flex flex-row justify-content-center" style="height:4rem">
                        <a style="height:2rem;width:2rem" class="btn-circle d-flex flex-row justify-content-center" href="#"><img class="delete-icon img-fluid" src=""></a>
                    </div>
                </div>
            </div>
        -->
        <button id="click">click</button>    
        <div id="display"></div>
        <div id="debug"></div>
    </body>
</html>
